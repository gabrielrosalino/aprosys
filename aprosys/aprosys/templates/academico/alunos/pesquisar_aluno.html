{% extends 'logged_base.html' %}
{% load static %}

{% block title %}Aprova System | Pesquisar Aluno{% endblock %}

{% block content %}

  <!-- --------- TÍTULO DA PÁGINA (DK + MB) --------- -->
  <div class="report-header">
    <h3 class="report-subtitle">Pesquisar</h3>
    <h1 class="report-title">Aluno</h1>
  </div>

  <!-- CAMPO DE PESQUISA (DK + MB) -->
  <form
    id="search-form"
    action="{% url 'pesquisar_aluno' %}"
    method="get"
    class="search-container search-container-table"
  >
    <input
      id="search-input"
      type="text"
      name="q"
      placeholder="Pesquise por um aluno"
      value="{{ q|urlencode }}"
      autocomplete="off"
    >
    <button
      id="clear-btn"
      type="button"
      class="clear-button"
      aria-label="Limpar pesquisa"
    >&times;</button>
  </form>

  <!-- --------- TABELA DE ALUNOS (DK + MB) --------- -->
  <table>
    <thead>
      <tr>
        <th class="sortable" data-field="nome">
          <span>Aluno</span>
          {% if order == 'nome' %}
            <span>{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
          {% endif %}
        </th>
        <th class="sortable" data-field="status">
          <span>Status</span>
          {% if order == 'status' %}
            <span>{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
          {% endif %}
        </th>
        <th data-field="editar">
          <span>Editar</span>
        </th>
      </tr>
    </thead>
    <tbody>
      {% if alunos %}
        {% for aluno in alunos %}
          <tr>
            <td>
                <a href="{% url 'detalhes_aluno' aluno.id %}">{{ aluno.nome }}</a>
            </td>
            <td>{{ aluno.get_status_display }}</td>
            <!-- Anderson -->
            <td>
              <a href="{% url 'editar_aluno' aluno.id %}">              
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="edit-button"alt="Botão editar">
                  <path fill="currentColor" d="M439.5 107.8C447.1 100.2 457.3 96 468 96C478.7 96 488.9 100.2 496.5 107.8L532.2 143.5C539.8 151.1 544 161.3 544 172C544 182.7 539.8 192.9 532.2 200.5L473.7 259L381 166.3L439.5 107.8zM358.3 189L451 281.7L238.2 494.4C231.4 501.2 222.9 506.2 213.6 508.8L99.5 540.5L131.2 426.4C133.8 417.1 138.7 408.6 145.6 401.8L358.3 189zM468 64C448.8 64 430.4 71.6 416.9 85.2L122.9 379.2C112.2 389.9 104.4 403.3 100.3 417.9L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L555 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64z"/>
                </svg>
              </a>
            </td>
            <!--  -->
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="2">Nenhum aluno encontrado.</td> 
        </tr>
      {% endif %}
    </tbody>
  </table>

  <script>
    // executa só depois que o HTML todo for inserido
    document.addEventListener('DOMContentLoaded', function(){
      const form     = document.getElementById('search-form');
      const input    = document.getElementById('search-input');
      const clearBtn = document.getElementById('clear-btn');
      const qParam   = "{{ q|escapejs }}";
      let orderParam= "{{ order }}";
      let dirParam  = "{{ dir }}";

      // Enter dispara busca
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          form.submit();
        }
      });

      // × limpa e recarrega
      clearBtn.addEventListener('click', () => {
        input.value = '';
        form.submit();
      });

      // cabeçalhos clicáveis
      document.querySelectorAll('th.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const field = th.dataset.field;
          let newDir = 'asc';
          if (field === orderParam) {
            newDir = dirParam === 'asc' ? 'desc' : 'asc';
          }
          const params = new URLSearchParams();
          if (qParam) params.set('q', qParam);
          params.set('order', field);
          params.set('dir', newDir);
          window.location.search = params.toString();
        });
      });
    });
  </script>
  
{% endblock %}
