{% extends 'logged_base.html' %}
{% load static %}

{% block title %}Aprova System | Pesquisar Disciplina {% endblock %}

{% block content %}

    <!-- --------- TÍTULO DA PÁGINA (DK + MB) --------- -->
    <div class="report-header">
        <h3 class="report-subtitle">Pesquisar</h3>
        <h1 class="report-title">Disciplina</h1>
    </div>

    <!-- --------- CAMPO DE PESQUISA EM TABELAS + BOTÃO DE EXCLUSÃO EM MASSA --------- -->
    <div style="display: flex; align-items: center; justify-content:space-between; margin-top: 40px; margin-bottom: 20px; min-height: 45px;">
        
        <!-- CAMPO DE PESQUISA (DK + MB) -->
        <form id="search-form" action="{% url 'pesquisar_disciplina' %}" method="get" 
            class="search-container search-container-table" style="margin: 0; flex-grow: 1; max-width: 300px;">
            <input id="search-input" type="text" name="q" placeholder="Pesquise por uma disciplina" value="{{ q|urlencode }}" autocomplete="off">
            <button id="clear-btn" type="button" class="clear-button" aria-label="Limpar pesquisa">&times;</button>
        </form>

        <!-- BOTÃO DE EXCLUSÃO MÚLTIPLA (DK + MB) -->
        <div id="bulk-actions-container" style="visibility: hidden; margin-left: 20px;">
            <button type="button" id="btn-delete-selected" class="btn btn-cancel" style="margin: 0; white-space: nowrap;">
                Excluir Selecionadas
            </button>
        </div>
    </div>

    <!-- --------- BOTÕES DE FILTRO DE PESQUISA (DK + MB) --------- -->
    <div class="d-md-none mobile-filter-container">
        <div class="mobile-filter-wrapper">
            <button type="button" class="filter-btn active" id="filter-status">Status</button>
            <button type="button" class="filter-btn" id="filter-area">Área de Conhecimento</button>
        </div>
    </div>

    <!-- --------- TABELA DE DISCIPLINAS (DK) --------- -->
    <div class="d-none d-md-block">
        <table>

            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-disciplinas"></th>
                    <th class="sortable" data-field="nome">
                        <span>Disciplina</span>
                        {% if order == 'nome' %}
                            <span>{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </th>
                    <th class="sortable" data-field="area_conhecimento">
                        <span>Área de Conhecimento</span>
                        {% if order == 'area_conhecimento' %}
                            <span>{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </th>
                    <th class="sortable" data-field="status">
                        <span>Status</span>
                        {% if order == 'status' %}
                            <span>{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </th>
                    <th class="table-action-cell"><span>Editar</span></th>
                    <th class="table-action-cell"><span>Excluir</span></th>
                </tr>
            </thead>
            
            <tbody>
                {% if disciplinas %}
                    {% for disciplina in disciplinas %}
                        <tr>
                            <td><input type="checkbox" class="disciplina-checkbox" value="{{ disciplina.pk }}"></td>
                            <td>{{ disciplina.nome }}</td>
                            <td>{{ disciplina.get_area_conhecimento_display }}</td>
                            <td>{{ disciplina.get_status_display }}</td>
                            <td class="table-action-cell">
                                <a href="{% url 'editar_disciplina' disciplina.pk %}">              
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="edit-button">
                                        <path fill="currentColor" d="M439.5 107.8C447.1 100.2 457.3 96 468 96C478.7 96 488.9 100.2 496.5 107.8L532.2 143.5C539.8 151.1 544 161.3 544 172C544 182.7 539.8 192.9 532.2 200.5L473.7 259L381 166.3L439.5 107.8zM358.3 189L451 281.7L238.2 494.4C231.4 501.2 222.9 506.2 213.6 508.8L99.5 540.5L131.2 426.4C133.8 417.1 138.7 408.6 145.6 401.8L358.3 189zM468 64C448.8 64 430.4 71.6 416.9 85.2L122.9 379.2C112.2 389.9 104.4 403.3 100.3 417.9L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L555 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64z"/>
                                    </svg>
                                </a>
                            </td>
                            <td class="table-action-cell">
                                <a href="{% url 'excluir_disciplina' disciplina.pk %}" onclick="return confirm('Excluir {{ disciplina.nome }}?');">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="delete-button">
                                        <path fill="currentColor" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/>
                                    </svg>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6">Nenhuma disciplina encontrada.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- --------- TABELA DE DISCIPLINAS (MB) --------- -->
    <div class="d-md-none mobile-list-interface">
        <div id="mobile-list-content">
        </div>
    </div>

    {{ disciplinas_json|json_script:"disciplinas-data" }}

    <!-- BOTÃO DE EXCLUSÃO MÚLTIPLA (MB) -->
    <div id="mobile-fab-delete" class="fab-delete d-md-none" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon-white">
            <path fill="white" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/>
        </svg>
    </div>

    <!-- --------- FORMULÁRIO DE EXCLUSÃO MÚLTIPLA - BACKEND (DK + MB) --------- -->
    <form id="bulk-delete-form" action="{% url 'excluir_disciplinas_massa' %}" method="POST" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="disciplina_ids" id="disciplina-ids-input">
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. Seleção de Elementos e Dados ---
            let rawData = [];
            const dataElement = document.getElementById('disciplinas-data');
            
            if (dataElement) {
                try {
                    const content = dataElement.textContent.trim();
                    rawData = JSON.parse(content);
                    if (typeof rawData === 'string') rawData = JSON.parse(rawData);
                } catch (e) {
                    console.error("Erro ao processar dados das disciplinas:", e);
                }
            }

            const mobileListContent = document.getElementById('mobile-list-content');
            const btnStatus = document.getElementById('filter-status');
            const btnArea = document.getElementById('filter-area');
            
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-btn');
            const selectAll = document.getElementById('select-all-disciplinas');
            const bulkContainer = document.getElementById('bulk-actions-container');
            const btnDeleteSelected = document.getElementById('btn-delete-selected');
            const bulkForm = document.getElementById('bulk-delete-form');
            const bulkInput = document.getElementById('disciplina-ids-input');
            const btnFabDelete = document.getElementById('mobile-fab-delete');

            // --- 2. Funções de Renderização Dinâmica ---

            function renderMobileUI(criterio = 'status') {
                if (!mobileListContent || !Array.isArray(rawData)) return;
                mobileListContent.innerHTML = ''; 

                const grupos = rawData.reduce((acc, item) => {
                    const chave = criterio === 'status' ? item.status_display : item.area_display;
                    if (!acc[chave]) acc[chave] = [];
                    acc[chave].push(item);
                    return acc;
                }, {});

                Object.keys(grupos).sort().forEach(titulo => {
                    const itens = grupos[titulo];
                    const groupDiv = document.createElement('div');
                    groupDiv.className = `mobile-group ${titulo === 'Inativo' ? 'collapsed' : ''}`;

                    groupDiv.innerHTML = `
                        <div class="group-header">
                            <div class="group-header-content">
                                <input type="checkbox" class="select-group-checkbox">
                                <span class="group-title">${titulo} (${itens.length})</span>
                            </div>
                            <span class="filter-toggle">▼</span>
                        </div>
                        <div class="mobile-group-content">
                            ${itens.map(item => `
                                <div class="mobile-item-row">
                                    <input type="checkbox" class="disciplina-checkbox" value="${item.id}">
                                    <span class="item-name">${item.nome}</span>
                                    <div class="item-actions">
                                        <a href="/academico/disciplinas/editar/${item.id}/">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="edit-button"><path fill="currentColor" d="M439.5 107.8C447.1 100.2 457.3 96 468 96C478.7 96 488.9 100.2 496.5 107.8L532.2 143.5C539.8 151.1 544 161.3 544 172C544 182.7 539.8 192.9 532.2 200.5L473.7 259L381 166.3L439.5 107.8zM358.3 189L451 281.7L238.2 494.4C231.4 501.2 222.9 506.2 213.6 508.8L99.5 540.5L131.2 426.4C133.8 417.1 138.7 408.6 145.6 401.8L358.3 189zM468 64C448.8 64 430.4 71.6 416.9 85.2L122.9 379.2C112.2 389.9 104.4 403.3 100.3 417.9L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L555 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64z"/></svg>
                                        </a>
                                        <a href="#" onclick="confirmarExclusaoUnica('${item.id}', '${item.nome}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="delete-button"><path fill="currentColor" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                                        </a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    mobileListContent.appendChild(groupDiv);
                });

                vincularEventosMestre();
                updateUI(); 
            }

            // --- 3. Funções de Sincronização e Interface ---

            function vincularEventosMestre() {
                document.querySelectorAll('.filter-toggle').forEach(arrow => {
                    arrow.onclick = function(e) {
                        e.stopPropagation();
                        this.closest('.mobile-group').classList.toggle('collapsed');
                    };
                });

                document.querySelectorAll('.select-group-checkbox').forEach(gs => {
                    gs.onchange = function() {
                        const isChecked = this.checked;
                        const groupRows = this.closest('.mobile-group').querySelectorAll('.disciplina-checkbox');
                        groupRows.forEach(cb => {
                            cb.checked = isChecked;
                            sincronizarCheckbox(cb.value, isChecked);
                        });
                        updateUI();
                    };
                });

                document.querySelectorAll('.disciplina-checkbox').forEach(cb => {
                    cb.onchange = function() {
                        sincronizarCheckbox(this.value, this.checked);
                        updateUI();
                    };
                });
            }

            function sincronizarCheckbox(id, estado) {
                document.querySelectorAll(`.disciplina-checkbox[value="${id}"]`).forEach(el => {
                    el.checked = estado;
                });
            }

            function updateUI() {
                const selected = document.querySelectorAll('.disciplina-checkbox:checked');
                const checkedCount = new Set(Array.from(selected).map(cb => cb.value)).size;
                const allCbs = document.querySelectorAll('.disciplina-checkbox');
                const totalUnique = new Set(Array.from(allCbs).map(cb => cb.value)).size;
                const isMobile = window.innerWidth <= 768;

                if (selectAll) selectAll.checked = (totalUnique > 0 && checkedCount === totalUnique);

                if (bulkContainer) {
                    bulkContainer.style.display = (checkedCount > 0 && !isMobile) ? 'block' : 'none';
                    bulkContainer.style.visibility = (checkedCount > 0 && !isMobile) ? 'visible' : 'hidden';
                }
                if (btnFabDelete) btnFabDelete.style.display = (checkedCount > 0 && isMobile) ? 'flex' : 'none';

                document.querySelectorAll('.disciplina-checkbox').forEach(cb => {
                    const row = cb.closest('tr');
                    if (row) cb.checked ? row.classList.add('row-selected') : row.classList.remove('row-selected');
                    const mRow = cb.closest('.mobile-item-row');
                    if (mRow) cb.checked ? mRow.classList.add('item-selected') : mRow.classList.remove('item-selected');
                });
            }

            // --- 4. Eventos de Filtro (Pílulas Status/Área) ---

            btnStatus.onclick = () => {
                btnStatus.classList.add('active');
                btnArea.classList.remove('active');
                renderMobileUI('status');
            };

            btnArea.onclick = () => {
                btnArea.classList.add('active');
                btnStatus.classList.remove('active');
                renderMobileUI('area');
            };

            // --- 5. Eventos de Pesquisa e Limpeza (AQUI ESTAVA O ERRO!) ---

            if (searchInput && searchForm) {
                searchInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchForm.submit();
                    }
                });
            }

            if (clearBtn && searchInput && searchForm) {
                clearBtn.addEventListener('click', () => {
                    searchInput.value = ''; // Limpa o texto
                    searchForm.submit();    // Envia o formulário vazio para resetar a busca
                });
            }

            // --- 6. Eventos de Seleção e Exclusão em Massa ---

            if (selectAll) {
                selectAll.onchange = function() {
                    const isChecked = this.checked;
                    document.querySelectorAll('.disciplina-checkbox').forEach(cb => cb.checked = isChecked);
                    updateUI();
                };
            }

            function executarBulkDelete() {
                const selected = document.querySelectorAll('.disciplina-checkbox:checked');
                const ids = Array.from(new Set(Array.from(selected).map(cb => cb.value)));
                if (ids.length === 0) return;
                if (confirm(`Tem certeza que deseja excluir a(s) ${ids.length} disciplina(s) selecionada(s)?`)) {
                    bulkInput.value = ids.join(',');
                    bulkForm.submit();
                }
            }

            if (btnDeleteSelected) btnDeleteSelected.onclick = executarBulkDelete;
            if (btnFabDelete) btnFabDelete.onclick = executarBulkDelete;

            // Inicialização padrão
            renderMobileUI('status');

        }); // Fim do DOMContentLoaded

        // Função global (fora do DOMContentLoaded para ser acessível pelos links dinâmicos)
        function confirmarExclusaoUnica(id, nome) {
            if (confirm(`Excluir ${nome}?`)) {
                window.location.href = `/academico/disciplinas/excluir/${id}/`;
            }
        }
    </script>
{% endblock %}